# Single-node cluster (Sử dụng docker để chạy)
## 1. Chuẩn bị
### Server
Một server chạy ubuntu:
- IP: 10.2.0.201

Cài đặt docker:
- Chạy câu lệnh để gỡ cài đặt các gói gây xung đột:
```sh
sudo apt remove $(dpkg --get-selections docker.io docker-compose docker-compose-v2 docker-doc podman-docker containerd runc | cut -f1)
```

- Sử dụng repository `apt` để cài đặt:
    + Cài đặt repository `apt` của Docker:
    ```sh
    # Add Docker's official GPG key:
    sudo apt update
    sudo apt install ca-certificates curl
    sudo install -m 0755 -d /etc/apt/keyrings
    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    sudo chmod a+r /etc/apt/keyrings/docker.asc

    # Add the repository to Apt sources:
    sudo tee /etc/apt/sources.list.d/docker.sources <<EOF
    Types: deb
    URIs: https://download.docker.com/linux/ubuntu
    Suites: $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}")
    Components: stable
    Signed-By: /etc/apt/keyrings/docker.asc
    EOF

    sudo apt update
    ```

    Cài đặt các gói Docker:
    ```sh
    sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    ```

    Start và kiểm tra trạng thái của Docker:
    ```sh
    sudo systemctl start docker

    sudo systemctl status docker
    ```

## 2. Chạy Elasticsearch
Tạo một docker network (elastic)
```sh
docker network create elastic
```

Pull Elasticsearch image về
```sh
docker pull docker.elastic.co/elasticsearch/elasticsearch:9.2.4
```

Chạy một Elasticsearch container:
```sh
docker run --name es01 --net elastic -p 9200:9200 -it -m 1GB docker.elastic.co/elasticsearch/elasticsearch:9.2.4
```

Khi chạy lần đầu sẽ xuất hiện ELASTIC_PASSWORD và enrollment-token, nên lưu lại ra biến môi trường hoặc file
```sh
export ELASTIC_PASSWORD="your_password"
```

Nếu như bị trôi mất, có thể chui vào container chạy Elasticsearch để reset với câu lệnh:
```sh
docker exec -it es01 /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
docker exec -it es01 /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana
```

Copy http_ca.crt (SSL certificate) từ container ra ngoài máy local:
```sh
docker cp es01:/usr/share/elasticsearch/config/certs/http_ca.crt .
```

Tạo một REST API để kiểm tra Elasticsearch container đang chạy:
```sh
curl --cacert http_ca.crt -u elastic:$ELASTIC_PASSWORD https://localhost:9200
```

## 3. Chạy Kibana
Pull Kibana image về:
```sh
docker pull docker.elastic.co/kibana/kibana:9.2.4
```

Chạy một Kibana container:
```sh
docker run --name kib01 --net elastic -p 5601:5601 docker.elastic.co/kibana/kibana:9.2.4
```

Khi Kibana chạy, nó xuất ra một đường link duy nhất được tạo trên terminal. Dùng đường link đó để truy cập vào Kibana thông qua web browser

Trên web browser, nhập enrollment token đã được tạo khi chạy phần Elasticsearch ở trên

Có thể tạo lại với câu lệnh:
```
docker exec -it es01 /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana
```

Sau đó, đăng nhập vào Kibana với user `elastic` và password đã được lưu trước đó ra biến môi trường

Có thể tạo lại với câu lệnh:
```sh
docker exec -it es01 /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
```

### Giao diện kibana:
![kibana](img/3.png)

## 4. Chạy Logstash (Có thể không cài cũng được)
Pull Logstash image về:
```sh
docker pull docker.elastic.co/logstash/logstash:9.2.4
```

Tạo file pipeline configuration `~/pipeline/test.conf`:
```sh
input {
  beats {
    port => 5044
  }
}

filter {
  mutate {
    add_field => { "node" => "controller" }
  }
}

output {
  elasticsearch {
    hosts => ["https://10.2.0.201:9200"]
    user => "elastic"
    password => "BMSEstO=vA7YCROLi3sc"
    ssl_verification_mode => "none"
    index => "openstack-%{+YYYY.MM.dd}"
  }
}
```

Chạy một Logstash container với file .conf trên:
```sh
docker run --rm -it -v ~/pipeline/:/usr/share/logstash/pipeline/ docker.elastic.co/logstash/logstash:9.0.0
```

Khi này, Logstash sẽ lắng nghe trên port 5044, sau đó sẽ filter rồi đẩy dữ liệu ra Elasticsearch

## 5. Chạy Filebeat khi không dùng logstash
Pull Filebeat image về:
```sh
docker pull docker.elastic.co/beats/filebeat:9.2.4
```

Tạo file configure cho Filebeat `~/filebeat/filebeat.yml`
```sh
filebeat.inputs:
    - type: filestream
      id: system-logs
      paths:
        - /var/log/nova/*.log
        - /var/log/neutron/*.log
        - /var/log/keystone/*.log
        - /var/log/glance/*.log
        - /var/log/cinder/*.log
        - /var/log/placement/*.log

output.elasticsearch:
  hosts: ["https://es01:9200"]
  username: "elastic"
  password: "your_password"
  ssl.certificate_authorities:
    - /usr/share/filebeat/http_ca.crt
  ssl.verification_mode: certificate

processors:
  - add_host_metadata: {}
```

Chạy với `https://es01:9200` thì container filebeat phải add thêm network `elastic` để có thể phân giải được `es01`

Chạy một Filebeat container
```sh
docker run -d --name filebeat --user=root --network elastic -v /var/log:/var/log:ro -v ~/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro -v ~/http_ca.crt:/usr/share/filebeat/http_ca.crt:ro docker.elastic.co/beats/filebeat:9.2.4
```

Khi này, sẽ thấy các log trên sẽ được đẩy lên elasticsearch và có thể dùng kibana để hiển thị trên dashboard

![log](img/4.png)

## 6. Tạo thêm dataview 
![view](img/5.png)







