# Một số câu lệnh thường dùng với neutron
## 1. Quản lý network resources
### 1.1 Network
#### Tạo network
- Sử dụng câu lệnh neutron net-create hoặc openstack network create để tạo mới một external network theo kiểu flat

```sh
openstack network create --share --provider-physical-network provider --provider-network-type flat provider1
```

#### Kiểm tra các mạng hiện có

```sh
openstack network list

Hoặc

neutron net-list
```

#### Show thông tin của một network

```sh
neutron net-show <net-name>

Hoặc

openstack network show <net-name>
```

### 1.2. Subnet
#### Tạo subnet
- Tạo subnet cho network vừa tạo, tại đây ta khai báo dải mạng cấp dhcp và dns, gateway cho network.

- Lưu ý: đối với external network thì dải mạng khai báo phải trùng với dải provider để máy ảo ra ngoài.

```sh
openstack subnet create --network provider \
  --allocation-pool start=192.168.40.121,end=192.168.40.129 \
  --dns-nameserver 8.8.8.8 --gateway 192.168.40.1 \
  --subnet-range 192.168.40.0/24 provider
```

- Lưu ý: Đối với self-service network, ta cần tạo router và gán cổng cho nó. Đầu ra của router sẽ được gán vào dải provider và đầu còn lại là của self-service. Như vậy, các máy ảo có thể ra được ngoài internet.

```sh
openstack network set --external provider1
openstack network create selfservice1
openstack subnet create --subnet-range 192.168.1.0/24 \
  --network selfservice1 --dns-nameserver 8.8.8.8 selfservice1-v4
openstack router create router1
openstack router add subnet router1 selfservice1-v4
neutron router-gateway-set router1 provider
```

#### Xóa một subnet
- Để xóa subnet, bạn cần phải clear port trong router trước:
```sh
# B1: Đầu tiên cần xem những subnet đang có và lấy ID-subnet:
  neutron subnet-list

# B2: Xem danh sách những router đang có, lấy ID router chứa subnet cần xóa:
  neutron router-list

# B3: Xem các port của router để xem subnet selfservice đang gắn vào đâu:
  neutron router-port-list <ID-router>

# B4: Xóa subnet
  neutron router-interface-delete <ID-router> <ID-subnet>

# B5: Xóa subnet với câu lệnh
  neutron subnet-delete <ID_subnet>

# B6: Sau đó xóa router
  neutron router-delete <ID-router>

# B7: Xóa network bằng câu lệnh
  neutron net-delete <net_ID>
```

### 1.3 Quản lí security groups
- Security Groups là các firewall rules có trách nhiệm filter các dữ liệu đi vào và đi ra cho máy ảo. Chúng được implement bởi iptables rules.

#### Tạo mới một Security Group
```sh
nova secgroup-create apress-sgroup "Apress secgroup"

openstack security group create <tên security group>
```

#### Thêm rule vào cho security group
```sh
nova secgroup-add-rule apress-sgroup tcp 22 22 0.0.0.0/0

openstack security group rule create --remote-ip <ip-address> --dst-port <port-range> --protocol <protocol> --ingress|--egress <tên group>
```

#### Hiển thị danh sách các rule đang có của 1 security group
```sh
nova secgroup-list-rules apress-sgroup

openstack security group list
```

#### Gán security group vào máy ảo
```sh
nova add-secgroup vm01 apress-sgroup
```

#### Xóa security group khỏi máy ảo
```sh
nova remove-secgroup vm01 default
```

### 1.4 Floating
#### Tạo mới floating ip
```sh
openstack ip floating create <network>
```

#### Hiển thị danh sách các floating ip
```sh
openstack ip floating list
```

#### Gán floating ip vào server
```sh
openstack ip floating add <ip-address> <server>
```

### 1.5 Fixed IP
Xóa một ip từ một instance:
```sh
openstack server remove fixed ip <INSTANCE_ID> <IP>
```

Thêm IP mới:
```sh
openstack server add fixed ip --fixed-ip-address <IP> <INSTANCE_ID> <NETWORK_ID>
```

### 1.6 Cấu hình IP cho VM

Yêu cầu một IP mới cho VM

- Ngắt kết nối và xóa port với VM:
```sh
nova interface-detach <VM> <id port>

neutron port-delete <id port>
```

- Tạo một port mới:
```sh
neutron port-create --fixed-ip subnet_id=<subnet-id>  <net-id>
```

- Gắn port mới tạo được vào VM
```sh
nova interface-attach --port-id 8b7cef8f-ecbe-4351-9053-32667076af8f <vm>
```

- Sau đó khởi động lại máy ảo
```sh
nova reboot <server>
```

Cấp nhiều ip cho một card mạng của VM
- Một private network net0

- Một subnet net0-subnet0 thuộc mạng net0 có range ip 10.10.10.0/24

- Một public network external range ip 192.168.40.0/24

- Đầu tiên cần tạo một port:
```sh
neutron port-create net0 \
--fixed-ip subnet_id=net0-subnet0 \
--fixed-ip subnet_id=net0-subnet0

```

- Nếu muốn, có thể chỉ định IP cho port:
```sh
neutron port-create net0 \
--fixed-ip subnet_id=net0-subnet0,ip_address=10.10.10.18 \
--fixed-ip subnet_id=net0-subnet0,ip_address=10.10.10.19
```

- Sau đó tạo một máy ảo gắn port này vào:
```sh
nova boot \
--nic port-id=c4bb9651-8542-405a-9225-685da660e657 \
--flavor m1.nano \
--image cirros <name>
```


## 2. Một số các câu lệnh khởi động lại các service
```sh
systemctl restart openvswitch.service
systemctl restart neutron-server.service
systemctl restart neutron-openvswitch-agent.service
systemctl restart neutron-dhcp-agent.service
systemctl restart neutron-metadata-agent.service
systemctl restart neutron-l3-agent
```

Lấy ID của một project:
```sh
projectID=$(openstack project list | grep service | awk '{print $2}')
```













