# 1. Giới thiệu chung về Neutron
- OpenStack Networking cho phép bạn tạo và quản lí các network objects ví dụ như networks, subnets, và ports cho các services khác của OpenStack sử dụng. Với kiến trúc plugable, các plug-in có thể được sử dụng để triển khai các thiết bị và phần mềm khác nhau, nó khiến OpenStack có tính linh hoạt trong kiến trúc và triển khai.

- Dịch vụ Networking trong OpenStack (neutron) cũng cấp API cho phép bạn định nghĩa các kết nối mạng và gán địa chỉ ở trong môi trường cloud. Nó cũng cho phép các nhà khai thác vận hành các công nghệ networking khác nhau cho phù hợp với mô hình điện toán đám mây của riêng họ. Neutron cũng cung cấp một API cho việc cấu hình cũng như quản lí các dịch vụ networking khác nhau từ L3 forwarding, NAT cho tới load balancing, perimeter firewalls, và virtual private networks.

Neutron có những thành phần sau:

### API server
- OpenStack Networking API hỗ trợ Layer2 networking và IP address management (IPAM - quản lý địa chỉ IP), cũng như một extension để xây dựng router Layer 3 cho phép định tuyến giữa các networks Layer 2 và các gateway để ra mạng bên ngoài. OpenStack Networking cung cấp một danh sách các plug-ins (đang ngày càng tăng lên) cho phép tương tác với nhiều công nghệ mạng mã nguồn mở và cả thương mại, bao gồm các routers, switches, switch ảo và SDN controller.

### OpenStack Networking plug-in and agents
- Các plugin và các agent này cho phép gắn và gỡ các ports, tạo ra network hay subnet, và đánh địa chỉ IP. Lựa chọn plugin và agents nào là tùy thuộc vào nhà cung cấp và công nghệ sử dụng trong hệ thống cloud nhất định. Điều quan trọng là tại một thời điểm chỉ sử dụng được một plug-in.

### Messaging queue
- Tiếp nhận và định tuyến các RPC requests giữa các agents để hoàn thành quá trình vận hành API. Các Message queue được sử dụng trong ML2 plugin để thực hiện truyền thông RPC giữa neutron server và các neutron agents chạy trên mỗi hypervisor, cụ thể là các ML2 driver cho Open vSwitch và Linux bridge.

# 2. Các khái niệm network trong Openstack Networking
### 2.1. Provider Network
- Provider network cung cấp một network layer 2 tới các instance với sự hỗ trợ của DHCP và metadata. Mạng này kết nối hoặc map tới một network layer 2 có trong datacenter, thường kết hợp với 802.1Q (VLAN)

- Provider network cung cấp sự đơn giản, hiều suất và độ tin cậy với chi phí linh hoạt. Mặc định thì chỉ có administrators mới có thể tạo và update loại mạng này, vì chúng đòi hỏi tới việc cấu hình physical network infrastructure. Nhưng vẫn có thể cho phép các user khác có quyển tạo và update loại mạng này bằng cách sửa trong file policy.json

```sh
    create_network:provider:physical_network
    update_network:provider:physical_network
```

- Ngoài ra, các mạng của nhà cung cấp chỉ xử lý kết nối layer 2 trong các trường hợp, do đó thiếu hỗ trợ cho các tính năng như route và floating IP address.

- Trong nhiều trường hợp, người vẫn hành đã quen thuộc với kiến trúc mạng ảo dựa vào cơ sở hạ tầng mạng vật lý cho layer 2 và 3 hoặc các dịch vụ khác có thể triển khai cùng các dịch vụ mạng Openstack.

- Đặc biệt, provider network thu hút các nhà triển khai di chuyển từ compute networking service (nova-network) sang Openstack networking service.

- Nhìn chung, các thành phần của OpenStack Networking xử lý layer-3 ảnh hưởng tới hệu năng và độ tin cậy rất nhiều. Để cải thiện hiệu suất và độ tin cậy, provider network di chuyển các hoạt động ở layer-3 tới physical network infrastructure.

- Trong một trường hợp cụ thể, Openstack được triển khai trong một môi trường được kết hợp với conventional virtualization và bare-metal hosts (sở hữu một cơ sở hạ tầng vậy lý khá lớn). Các ứng dụng chạy trên Ops được triển khai phải truy cập trực tiếp với layer-2, thông thường sẽ sử dụng VLAN, cho phép các ứng dụng outside triển khai.

### 2.2. Routed provider networks
- Routed provider networks cung cấp các kết nối layer-3 cho các instance. Những networks này sẽ map với các networks layer-3 trong data center. Cụ thể hơn, network sẽ map với nhiều segment layer-2, mỗi cái đó bản chất là một provider network. Mỗi một mạng sẽ có một router gateway đi kèm để nó có thể định tuyến traffic giữa chúng với bên ngoài. Networking service không cung cấp việc định tuyến.

- Routed provider networks tất nhiên sẽ có hiệu suất thấp hơn so với provider networks.

### 2.3 Self-service network (tenant)
- Self-service network cho phép các general (non-privileged) projects có thể quản lý networks mà không cần quyền admin. Các mạng này hoàn toàn ảo và yêu cấu các router ảo để tương tác với provider và external networks. Self-service networks thường sẽ tự cung cấp DHCP và metadata service cho instance.

- Trong hầu hết các trường hợp, mạng self-service sẽ sử dụng các giao thức overlay như VXLAN hoặc GRE, vì chúng hỗ trợ nhiều network hơn layer-2 segmentation sử dụng VLAN tagging (802.1q). Hơn nữa VLANs thường yêu cầu cấu hình thêm physical network infrastructure.

- IPv4 trong self-service thường sử dụng IP Private ( RFC 1918 ) và tương tác với provider network bằng Source NAT sử dụng router ảo. Floating IP address cho phép truy cập instance từ provider network bằng Destination NAT sử dụng Router ảo

- IPv6 trong self-service sử dụng IP Public và tương tác với provider network sử dụng các static route thông qua các Router ảo

- Trong openstack networking tích hợp một router layer-3 thường nằm ít nhất trên một node network. Trái ngược với provider network kết nối tới các instance thông qua hạ tầng mạng vật lý layer-2

- Người dùng có thể tạo các selt-network theo từng project. Bởi vậy các kết nối sẽ không được chia sẻ với các project khác.

- Người dùng tạo các kết nối project networks trong project. Mặc định, chúng sẽ hoàn toàn bị cô lập và không được chia sẽ với các projects khác. Openstack hỗ trợ một số kiểu mạng isolation và công nghệ overlay sau: Flat, VLAN, GRE and VXLAN

- Flat
    - Tất cả các instance đều nằm trong một mạng, nó có thể được chia sẽ giữa các hosts. Không có VLAN tagging IDs (802.1Q tagged) và không có sự chia cắt mạng.

- VLAN
    - Mạng cho phép khởi tạo nhiều provider hoặc tenant network2 sử dụng VLAN (801.2q) , tương ứng với VLAN đang có sẵn trên mạng vật lý. Điều này cho phép instance kết nối tới các thành phần khác trong mạng

- GRE and VXLAN
    - VXLAN và GRE là giao thức đóng gói packet (encapsulation) tạo ra các overlay networks để kích hoạt và điều khiển giữa các máy ảo. Một router ảo để kết nối từ tenant network ra external network. Một router provider sử dụng để kết nối từ external network vào các instance trong tenant network sử dụng floating IP.

![network](img/network.png)

### 2.4. Một số khái niệm khác
#### Subnets
- Là một khối tập hợp các địa chỉ IP và đã được cấu hình. Quản lý các địa chỉ IP của subnet do IPAM driver thực hiện. Subnet được dùng để cấp phát các địa chỉ IP khi ports mới được tạo trên network.

#### Subnet pools
- Người dùng cuối thông thường có thể tạo các subnet với bất kì địa chỉ IP hợp lệ nào mà không bị hạn chế. Tuy nhiên, trong một vài trường hợp, sẽ là ổn hơn nếu như admin hoặc tenant định nghĩa trước một pool các địa chỉ để từ đó tạo ra các subnets được cấp phát tự động. Sử dụng subnet pools sẽ ràng buộc những địa chỉ nào có thể được sử dụng bằng cách định nghĩa rằng mỗi subnet phải nằm trong một pool được định nghĩa trước. Điều đó ngăn chặn việc tái sử dụng địa chỉ hoặc bị chồng lấn hai subnets trong cùng một pool.

#### Ports
- Là điểm kết nối để attach một thiết bị như card mạng của máy ảo tới mạng ảo. Port cũng được cấu hình các thông tin như địa chỉ MAC, địa chỉ IP để sử dụng port đó.

#### Router
- Cung cấp các dịch vụ layer 3 ví dụ như định tuyến, NAT giữa các self service và provider network hoặc giữa các self service với nhau trong cùng một project.

#### Security groups
- Một security groups được coi như một firewall ảo cho các máy ảo để kiểm soát lưu lượng bên trong và bên ngoài router. Security groups hoạt động mức port, không phải mức subnet. Do đó, mỗi port trên một subnet có thể được gán với một tập hợp các security groups riêng. Nếu không chỉ định group cụ thể nào khi vận hành, máy ảo sẽ được gán tự động với default security group của project. Mặc định, group này sẽ hủy tất cả các lưu lượng vào và cho phép lưu lượng ra ngoài. Các rule có thể được bổ sung để thay đổi các hành vi đó. Security group và các security group rule cho phép người quản trị và các tenant chỉ định loại traffic và hướng (ingress/egress) được phép đi qua port. Một security group là một container của các security group rules.

- Các rules trong security group phụ thuộc vào nhau. Vì thế nếu bạn cho phép inbound TCP port 22, hệ thống sẽ tự động tạo ra 1 rule cho phép outbound traffic trả lại và ICMP error messages liên quan tới các kết nối TCP vừa được tạo rules.

- Mặc định, mọi security groups chứa các rules thực hiện một số hành động sau:
    + Cho phép traffic ra bên ngoài chỉ khi nó sử dụng địa chỉ MAC và IP của port máy ảo, cả hai địa chỉ này được kết hợp tại `allowed-address-pairs`

    + Cho phép tín hiệu tìm kiếm DHCP và gửi message request sử dụng MAC của port cho máy ảo và địa chỉ IP chưa xác định.

    + Cho phép trả lời các tín hiệu DHCP và DHCPv6 từ DHCP server để các máy ảo có thể lấy IP

    + Từ chối việc trả lời các tín hiệu DHCP request từ bên ngoài để tránh việc máy ảo trở thành DHCP server

    ...

- Mặc dù cho phép non-IP traffic nhưng security groups không cho phép các ARP traffic. Có một số rules để lọc các tín hiệu ARP nhằm ngăn chặn việc sử dụng nó để chặn tín hiệu tới máy ảo khác. Bạn không thể xóa hoặc vô hiệu hóa những rule này. Bạn có thể hủy security groups bằng các sửa giá trị dòng `port_security_enabled` thành `False`.

#### Extensions
- OpenStack Networking service có khả năng mở rộng. Có hai mục đích chính cho việc này: cho phép thực thi các tính năng mới trên API mà không cần phải đợi đến khi ra bản tiếp theo và cho phép các nhà phân phối bổ sung những chức năng phù hợp. Các ứng dụng có lấy danh sách các extensions có sẵn sử dụng phương thức GET trên /extensions URI. Chú ý đây là một request phụ thuộc vào phiên bản OpenStack, một extension trong một API ở phiên bản này có thể không sử dụng được cho phiên bản khác.

#### DHCP
- Dịch vụ tùy chọn DHCP quản lí địa chỉ IP trên provider và self-service networks. Networking service triển khai DHCP service sử dụng agent quản lí qdhcp namespaces và dnsmasq service.

#### Metadata
- Dịch vụ tùy chọn cung cấp API cho instance lấy các thông cho instance đó như IP address, hostname, SSH key, cloud-init script do nova cung cấp.

#### Open vSwitch
- OpenvSwitch (OVS) là công nghệ switch ảo hỗ trợ SDN (Software-Defined Network), thay thế Linux bridge. OVS cung cấp chuyển mạch trong mạng ảo hỗ trợ các tiêu chuẩn Netflow, OpenFlow, sFlow. OpenvSwitch cũng được tích hợp với các switch vật lý sử dụng các tính năng lớp 2 như STP, LACP, 802.1Q VLAN tagging. OVS tunneling cũng được hỗ trợ để triển khai các mô hình network overlay như VXLAN, GRE.

#### L3 Agent
- L3 agent là một phần của package openstack-neutron. Nó được xem như router layer3 chuyển hướng lưu lượng và cung cấp dịch vụ gateway cho network lớp 2. Các nodes chạy L3 agent không được cấu hình IP trực tiếp trên một card mạng mà được kết nối với mạng ngoài. Thay vì thế, sẽ có một dải địa chỉ IP từ mạng ngoài được sử dụng cho OpenStack networking. Các địa chỉ này được gán cho các routers mà cung cấp liên kết giữa mạng trong và mạng ngoài. Miền địa chỉ được lựa chọn phải đủ lớn để cung cấp địa chỉ IP duy nhất cho mỗi router khi triển khai cũng như mỗi floating IP gán cho các máy ảo.

    + DHCP Agent: OpenStack Networking DHCP agent chịu trách nhiệm cấp phát các địa chỉ IP cho các máy ảo chạy trên network. Nếu agent được kích hoạt và đang hoạt động khi một subnet được tạo, subnet đó mặc định sẽ được kích hoạt DHCP.

    + Plugin Agent: Nhiều networking plug-ins được sử dụng cho agent của chúng, bao gồm OVS và Linux bridge. Các plug-in chỉ định agent chạy trên các node đang quản lý lưu lượng mạng, bao gồm các compute node, cũng như các nodes chạy các agent







