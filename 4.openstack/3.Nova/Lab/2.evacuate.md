# Evacuate vm 
Trong OpenStack, khi thực hiện thao tác evacuate instance, dịch vụ Nova không chỉ khởi tạo lại máy ảo trên compute khác mà còn phải làm việc trực tiếp với Neutron để cấu hình lại kết nối mạng cho instance.

Nova cần cập nhật thông tin binding của port Neutron để:

- Gán lại port sang compute host mới

- Cập nhật binding:profile phục vụ quá trình migrate / evacuate

- Đảm bảo interface của VM được plug đúng backend (OVS, Linux Bridge, SR-IOV…)

Cần cấu hình policy cho phép user nova thực hiện:
```sh
#file policy.yaml
update_port: role:admin or role:service
update_port:binding:profile: role:admin or role:service
```

Thực hiện evacuate
```sh
openstack server evacuate --host [target-host] --password [password] <server>
```

Note: 
- Với vm sử dụng volume, vm được build lại và gắn volume -> dữ liệu được bảo toàn

- Với vm sử dụng local disk, vm chỉ build lại và sẽ được tạo một folder để lưu trữ dữ liệu trên compute build lại vm đó

# Evacuate vm (local disk) khi ổ đĩa vẫn còn sử dụng được
Cần copy folder làm disk cho vm trên ổ đĩa sang compute sẽ dùng để build lại vm
```sh
#Cần copy vào folder /var/lib/nova/instances/
```

Sửa quyền cho file và folder đó
```sh
# Ví dụ
drwxr-x--x  2 nova         nova      4096 Jan 15 01:40 ./
drwxr-x--- 16 nova         nova      4096 Jan 15 01:48 ../
-rw-------  1 root         root     26234 Jan 15 01:40 console.log
-rw-r-----  1 libvirt-qemu kvm  862715904 Jan 15 01:45 disk
-rw-r-----  1 nova         nova        79 Jan 15 01:40 disk.info
```

Evacuate vm
```sh
openstack server evacuate --host [target-host] --password [password] <server>
```

Khi này, vm sẽ được build lại và map disk với folder đã copy sang dựa theo id của vm

Dữ liệu trên vm vẫn còn



























