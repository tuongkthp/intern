# Dùng cloud-init để tạo user, cài apache2, chạy dịch vụ web
Trước tiên, cần cấu hình cho metadata service tại đây -> [Metadata](../4.Neutron/9.Metadata.md)

Tạo file `user-data.yaml`
```sh
#cloud-config
users:
  - name: tuong123
    gecos: vu kim quang tuong
    shell: /bin/bash
    groups: users,adm,sudo
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: true
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCPwUbmRKKaHPIvPvMLqk/ootqV6O2u0JzREUEobv2cNxPMFNpu+auGF/E6fJNbi6mvKN5yT8IOqW7OsFkEfLm7irGaZynaiCLYK1QXutfvrgXegaXdF26SqZF+IxHHws0uMPuJvxM7b36rUvosY7U+sREISuet+Jyo58d745tQrkQVPL3ynPrz/LdJDopOGZ2fXvBRkfgulUxxbgxRL9CcQOZZ14F+lUuK3aRhnXTpMdHkWMMMbkuofqhiCbqiBB427maXH0vV+nlXRrEniq1YahjBvw6X/Tgr2e+qYVFsD6H2uCNrowFryFnrXKpItq+GUcZUM9pC/R1hxsh0LB5KCM4MtqlnMnCksS9R0Dm2Z/jLt0cBa/zrbEYEjV1GRxOksRcurKjMddb716QLih1Wb4Xv1Yb357OkUch0GMaMc2PWjcT7JXXMQgcz3cmyEFffpOw6LxJFUOKCoPT6m0VUQ4n6Q6/1YHy8OaznbyEd5G8fjE2CwcuK2F5Vbht0y9E= root@hapu-lab-01

package_update: true
packages:
  - apache2
        
runcmd:
  - systemctl enable apache2
  - systemctl start apache2
  - echo "<h1 style="color:red">MY NAME IS TUONG</h1>" > /var/www/html/index.html
```

Tạo instance với file cloud-config trên
```sh
openstack server create \
--flavor type1 \
--image ubuntu22-04 \
--network selfservice \
--security-group 3a7af6c7-360c-4774-884b-ba4a34395bc9 \
--user-data user-data.yaml \
cloud-init-test3
```

Lưu ý: 
- Security group cần có các rule cho phép ssh (port 22), http (port 80),...
- Nếu dùng mạng selfservice cần gắn thêm floating IP để có thể truy cập từ xa

Kiểm tra kết quả khi instance tạo xong, sẽ truy cập được vào web theo địa chỉ của instance

![web](img/web.png)
