# 1. Policy
- Mỗi một service của Openstack (Identity, Compute,..) đều có một role-based access policies riêng. Chúng quy định các user nào có quyền truy cập tới object nào và bằng cách nào. Tất cả được định nghĩa trong một file policy.json

- Các file policy.json thường được đặt ở đường dẫn /etc/<project name>/policy.json

- Mỗi khi API gọi tới một dịch vụ nào đó, policy engine của service ấy sẽ sử dụng các policy đã được định nghĩa để xác định xem API call đó có hợp lệ hay không.

- Bất cứ sự thay đổi nào đối với file policy.json sẽ có tác dụng ngay lập tức, cho phép các policy mới có thể được thực thi ngay khi service vẫn đang chạy

- File `policy.yaml` có format json. Mỗi một policy sẽ được định nghĩa trên một dòng. Gồm hai phần như sau: `"<target>" : "<rule>"`

- `Target` là các actions, ví dụ: `compute, volume,...,` là các API Call để tạo máy ảo hoặc gán volume,... Các action này đã được định nghĩa sẵn.

# 2. Định nghĩa một số role
- Cấu trúc file yaml
```sh
"<rule>": "define rule",


"<target>": "<rule> or <role>"
```

- Để minh họa cho cấu trúc trên, ta định nghĩa role như sau: một role tên `tuong` cho user `tuong` có thể list user

### Tạo role, user, project
Tạo một project có tên `tuong`

```sh
root@tuong-tts-2025-lab-01:~# openstack project create --domain Default --description "Project tuong for testing role" tuong
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | Project tuong for testing role   |
| domain_id   | default                          |
| enabled     | True                             |
| id          | 68dc5e131727440ab65d33a843b712ad |
| is_domain   | False                            |
| name        | tuong                            |
| options     | {}                               |
| parent_id   | default                          |
| tags        | []                               |
+-------------+----------------------------------+
```

Tạo một role tên `tuong`
```sh
 root@tuong-tts-2025-lab-01:~# openstack role create tuong
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| id          | ff5b2b7a6583465b92d8543dfe43365f |
| name        | tuong                            |
| domain_id   | None                             |
| description | None                             |
+-------------+----------------------------------+
```

Tạo một user tên `tuong`
```sh
 root@tuong-tts-2025-lab-01:~# openstack user create --domain Default --password tuong31 --enable --description "test role" tuong
+---------------------+----------------------------------+
| Field               | Value                            |
+---------------------+----------------------------------+
| default_project_id  | None                             |
| domain_id           | default                          |
| email               | None                             |
| enabled             | True                             |
| id                  | 13454ea0432044cf861b751ac96abe9b |
| name                | tuong                            |
| description         | test role                        |
| password_expires_at | None                             |
+---------------------+----------------------------------+
```

Gán role cho user và project
```sh
 root@tuong-tts-2025-lab-01:~# openstack role add --project tuong --user tuong tuong
```

Tạo một file `tuong-openrc` đẻ định danh user `tuong`
```sh
export OS_PROJECT_DOMAIN_NAME=default
export OS_USER_DOMAIN_NAME=default
export OS_PROJECT_NAME=tuong
export OS_USERNAME=tuong
export OS_PASSWORD=tuong31
export OS_AUTH_URL=http://14.225.1.147:5000/v3
export OS_IDENTITY_API_VERSION=3
export PS1='[\u@\h \W(keystone)]\$ '
```

Kiểm tra thử xem user `tuong` có list user được không
```sh
[root@tuong-tts-2025-lab-01 ~(keystone)]# openstack user list 
ForbiddenException: 403: Client Error for url: http://controller:5000/v3/users, You are not authorized to perform the requested action: identity:list_users.
```

### Định nghĩa rule
Rule sẽ được định nghĩa trong file /etc/keystone/keystone.policy.yaml như sau:

```sh
"identity:list_users": "role:admin or role:tuong"
```

Trỏ đến file policy trong file keystone.conf
```sh
[oslo_policy]
policy_file = keystone.policy.yaml
```

Restart keystone để nhận nhận lại cấu hình mới
```sh
systemctl restart apache2
```

### Kiểm tra kết quả
Dùng user `tuong` để list user
```sh
[root@tuong-tts-2025-lab-01 ~(keystone)]# . tuong-openrc 
[root@tuong-tts-2025-lab-01 ~(keystone)]# openstack user list
+----------------------------------+-----------+
| ID                               | Name      |
+----------------------------------+-----------+
| 13454ea0432044cf861b751ac96abe9b | tuong     |
| 317c7b8f58e941de8bc1ebe38d0bf764 | glance    |
| 31aa1f53088941afb54a74bbd468435a | tuongne   |
| 417efe8c7adc446a889111f13593bb37 | placement |
| 5d51c922d3e842689c71da5c6a766f2a | admin     |
| 65605b16f6d24564ae7cf95c085c7a32 | nova      |
| 7731eebf50a142eaa28f87baaffb7035 | tuong1    |
| 8c0d8273b6e647788afdac04f569c048 | myuser    |
| cb0a21617d184235a903b8c709f2ea32 | neutron   |
+----------------------------------+-----------+
```

### Lưu ý
Example command generate the default rules list:
```sh
oslopolicy-sample-generator --namespace [namespace] --output-file filename.yaml
```




