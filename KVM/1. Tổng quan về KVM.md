# 1. Tổng quan
- KVM (Kernel-based Virtual Machine) là một công nghệ ảo hóa phần cứng (hardware-assisted virtualization) được tích hợp trực tiếp vào Linux kernel

- Là giải pháp ảo hóa hoàn chỉnh cho Linux chạy trên phần cứng x86

- Cho phép chạy nhiều máy ảo (VM) với CPU, RAM, storage, network riêng giống như một server thật

- Ưu điểm: 
    + Hiệu suất cao: KVM tận dụng trực tiếp các tính năng ảo hóa của nhân Linux, mang lại hiệu suất gần như tiệm cận với máy vật lý

    + Khả năng mở rộng: KVM có thể hỗ trợ ảo hóa một lượng lớn máy ảo trên một máy chủ vật lý duy nhất

    + Tính linh hoạt: KVM hỗ trợ đa dạng hệ điều hành và nền tảng phần cứng, cho phép người dùng dễ dàng triển khai và quản lý các môi trường ảo hóa khác nhau

    + Tiết kiệm chi phí: KVM là giải pháp mã nguồn mở, miễn phí sử dụng

    + Bảo mật: KVM thừa hưởng các tính năng bảo mật của hệ điều hành Linux, giúp bảo vệ máy ảo khỏi các mối đe dọa an ninh mạng

- Nhược điểm: KVM có một số nhược điểm, bao gồm yêu cầu phần cứng hỗ trợ ảo hóa như CPU Intel VT hoặc AMD-V, đòi hỏi kiến thức kỹ thuật sâu về Linux và ảo hóa và hỗ trợ phần mềm thương mại hạn chế do một số phần mềm có thể không tương thích hoặc tối ưu hóa cho KVM

# 2. Kiến trúc KVM
- Gồm 3 thành phần chính:
    + KVM kernel module

    + quemu – kvm

    + libvirt management stack

- KVM kernel module:
    + Là một module được tích hợp vào Linux kernel

    + Cung cấp giao diện chung cho Intel VMX và AMD SVM (thành phần hỗ trợ ảo hóa phần cứng)
    
- quemu – kvm: 
    + Là chương trình dòng lệnh để tạo các máy ảo, thường được vận chuyển dưới dạng các package “kvm” hoặc “qemu-kvm”

    + Giúp thiết lập VM và các thiết bị ra vào (input/output)
        
    + Thực thi mã khách thông qua KVM kernel module Mô phỏng các thiết bị ra vào (I/O) và di chuyển các guest từ host này sang host khác

- libvirt management stack: 
    + Là một lớp quản lý, nó chịu trách nhiệm cung cấp API thực hiện các nhiệm vụ quản lý như cung cấp máy ảo, tạo, sửa đổi, giám sát, kiểm soát, di chuyển,...

    + libvirtd là một daemon chạy ngầm để cung cấp dịch vụ quản lý ảo hóa cho các tool như là virsh hay virt-manager

    + Cung cấp chế độ quản lí từ xa an toàn'

# 3. Cài đặt KVM trên ubuntu 24.04
- Cài đặt KVM và các package liên quan:
        
        sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager -y

- Khởi động dịch vụ libvirtd:

        systemctl start libvirtd

- Khởi động dịch vụ libvirtd cùng hê thống:

        systemctl enable libvirtd

- Dùng lệnh "virt-install" để tạo máy ảo (tạo từ image có sẵn/file iso/internet)

```sh
    # Tạo bằng iso có sẵn
    virt-install \
    --connect qemu:///system \
    --name ubuntu-server-22-04-1 \
    --ram 512 \
    --vcpus 2 \
    --disk path=/var/lib/libvirt/images/ubuntu-2204-1.qcow2,size=10,format=qcow2 \
    --os-variant ubuntu22.04 \
    --virt-type kvm \
    --graphics none \
    --cdrom /var/lib/libvirt/images/ubuntu-22.04.5-live-server-amd64.iso \
    --network network=default,model=virtio \
    --boot cdrom,hd
    --extra-args "console=ttyS0"
```

Tạo vm bằng qcow2
```sh
    #Tải file qcow2 về
    sudo wget https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img -O ubuntu-22.04.qcow2

```

```sh
    #Tạo file user-data để tạo user-data sẵn khi boot vm
    users:
    - name: ubuntu
        gecos: Ubuntu User
        sudo: ALL=(ALL) NOPASSWD:ALL
        groups: users, admin
        lock_passwd: false
        shell: /bin/bash
        passwd: $6$rounds=4096$abcd1234$9YJFEvUpMvnEybUp1rDqsrkhAb6T4Dv2VtxJo1z>
    ssh_pwauth: true

    chpasswd:
    expire: false
```

```sh
    # Tạo meta-data với file meta-data
    instance-id: ubuntu-01
    local-hostname: ubuntu-vm
```

```sh
    # TẠO SEED.ISO CHỨA CLOUD-INIT
    cloud-localds seed.iso user-data meta-data
```

```sh
    # Tạo bằng qcow2
    virt-install \
    --name ubuntu-cloud \
    --ram 2048 \
    --vcpus 2 \
    --disk path=/var/lib/libvirt/images/ubuntu-cloud.qcow2,format=qcow2  \
    --disk path=/var/lib/libvirt/images/seed.iso,device=cdrom \
    --import \
    --os-variant ubuntu22.04 \
    --network network=default,model=virtio \
    --graphics spice

```
