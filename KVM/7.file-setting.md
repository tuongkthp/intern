# 1. Tổng quan về file setting (file XML)
- VM trong KVM có 2 thành phần chính đó là VM's definition được lưu dưới dạng file XML mặc định ở thư mục /etc/libvirt/qemu và VM's storage lưu dưới dạng file image

- File domain XML chứa những thông tin về thành phần của máy ảo (số CPU, RAM, các thiết lập của I/O devices...)

- Libvirt dùng những thông tin này để tiến hành khởi chạy tiến trình QEMU-KVM tạo máy ảo

- KVM cũng có các file XML khác để lưu các thông tin liên quan tới network, storage...

- Mục đích chính của XML là đơn giản hóa việc chia sẻ dữ liệu giữa các hệ thống khác nhau, đặc biệt là các hệ thống được kết nối với Internet

# 2. Các thành phần của file XML
- File XML tổ chức theo khối lệnh, có nhiều khối lệnh cùng trong 1 khối lệnh tổng quan, cú pháp giống HTML có thẻ đóng, thẻ mở

### 2.1 Khối domain
- Khối này bao quát tổng thể toàn bộ hệ thống lưu trữ các thẻ trong XML.
    + Tham số `type` cho biết hypervisor đang sử dụng của VM

    + Các tham số bên trong có ý nghĩa như sau:
        
        `name`: Thông tin về VM

        `uuid`: Mã nhận dạng quốc tế duy nhất cho máy ảo. Format theo RFC 4122. Nếu thiếu trường uuid khi khởi tạo, mã này sẽ được tự động generate

    + Một số thẻ khác có thêm thông tin về các tham số như sau:
        
        `title`: Tiêu đề của máy ảo
        
        `description`: Đoạn mô tả của máy ảo
        
        `metadata`: Chứa những thông tin về file xml
        
        `memory`: Dung lượng RAM của máy ảo được cấp khi khởi tạo máy
        unit: Đơn vị, mặc định là KiB
        
        `currentMemory`: Dung lượng RAM đang được sử dụng tại thời điểm trích xuất file XML
        
        `maxMemory`: Dung lượng RAM tối đa có thể sử dụng
        
        `vcpu`: Tổng số vcpu máy ảo được cấp khi khởi tạo

    + `vcpu` có một số tham số:
        
        `cpuset`: Danh sách các cpu vật lý mà máy ảo sử dụng
        
        `current`: Chỉ định cho phép kích hoạt nhiều hơn số CPU đang sử dụng
        
        `placement`: Vị trí của cpu, giá trị bao gồm static và dynamic

### 2.2 Khối OS: 
- Khối os nằm trong khối domain. Nó khai báo các thành phần của OS guest.
    + Thẻ `type` có chứa arch là hệ điều hành thuộc kiên trúc 32 hay 64 bit và machine là thông tin về kernel hệ điều hành.
        `arch`: Hệ điều hành thuộc kiến trúc 32 hay 64 bit
        
        `machine`: Thông tin về kernel của hệ điều hành
        
        `loader`: Readonly có giá trị yes hoặc no chỉ ra file image 
        
        `writable` hay readonly, type có giá trị rom hoặc pflash chỉ ra nơi guest memory được kết nối
        
        `kernel`: Đường dẫn tới kernel image trên hệ điều hành máy chủ
    
    + Thẻ features là hypervisor cho phép 1 số option tự động bật /tắt.
        ```sh
        <features>
            <acpi/>
            <apic/>
            <vmport state='off'/>
        </features>
        ```

    + Hành động xảy ra đối với một số sự kiện của OS

        `on_poweroff`: Hành động được thực hiện khi người dùng yêu cầu tắt máy
        
        `on_reboot`: Hành động được thực hiện khi người dùng yêu cầu reset máy
        
        `on_crash`: Hành động được thực hiện khi có sự cố

    + Những hành động được phép thực thi:

        `destroy`: Chấm dứt và giải phóng tài nguyên
        
        `restart`: Chấm dứt rồi khởi động lại giữ nguyên cấu hình
        
        `preserve`: Chấm dứt nhưng dữ liệu vẫn được lưu lại
        
        `rename`-`restart`: Khởi động lại với tên mới
        
        `destroy` và `restart` được hỗ trợ trong cả `on_poweroff` và 
        `on_reboot`, `rename-restart` dùng trong `on_poweroff`

        ```sh
        <on_poweroff>destroy</on_poweroff>
        <on_reboot>restart</on_reboot>
        <on_crash>destroy</on_crash>
        ```

    + Thẻ cpu mô tả các yêu câu của guest host về CPU.
        ```sh
        <cpu mode='host-model' check='partial'>
            <model fallback='allow'/>
        </cpu>
        ```

        ```sh
        <cpu mode='host-model'>
            <model fallback='forbid'/>
            <topology sockets='1' cores='2' threads='1'/>
        </cpu>
        ```
    + `clock`: Thiết lập về thời gian

    + `offset`: Giá trị utc, localtime, timezone, variable

### 2.3 Khối device
- Khối device nằm trong khối domain. Nó hai bao thông tin vè thành phàn của guest host như như disk, network, I/O . . .

    + Thẻ `emulator`: Khai báo đường đãn tới thu viện ảo hóa các device.
        ```sh
        <emulator>/usr/bin/qemu-system-x86_64</emulator>
        ```

    + Thẻ `disk`: Khai báo thông tin về disk của máy ảo.
        ```sh
        <disk type='file' device='disk'>                            //Thông tin ổ disk.
            <driver name='qemu' type='qcow2'/>                    //định dạng của máy ảo
            <source file='/var/lib/libvirt/images/centos7.0.qcow2'/>  //đường dẫn chứa disk
            <target dev='vda' bus='virtio'/>                      // tên ổ và kiểu ảo hóa
            <address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/>
            </disk>

        <disk type='file' device='cdrom'>           //thông tin ổ đĩa CDROM
            <driver name='qemu' type='raw'/>      //định dạng của máy ảo.
            <target dev='sda' bus='sata'/>        //tên ổ CDROM và kiểu.
            <readonly/>                           //Chế độ chỉ đọc.
            <address type='drive' controller='0' bus='0' target='0' unit='0'/>
            </disk>
        ```
    
    + Thẻ `Controler`:
        * Tùy thuộc vào cấu trúc của máy ảo mà nó có thể có các thiết bị ảo đi kèm, mỗi cái lại đi theo một bộ điều khiển. Thường thì libvirt sẽ tự động chỉ ra mà không cần khai báo qua file xml.

        * Mỗi bộ điều khiển có một tham số bắt buộc là type và index, các giá trị có thể chọn của type là: ‘ide’, ‘fdc’, ‘scsi’, ‘sata’, ‘usb’, ‘ccid’, ‘virtio-serial’ hoặc ‘pci’. Trong khi đó index sẽ chỉ ra thứ tự ưu tiên.

    + Thẻ `interface`: Khai báo thông tin về networkcủa guest os.
        ```sh
        <interface type='direct'>
            <mac address='52:54:00:0d:1c:93'/>
            <source dev='tap2' mode='bridge'/>
            <model type='virtio'/>
            <link state='up'/>
            <address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/>
        </interface>
        ```
        * Các thông số trong thẻ.
            ```sh
            Mac address: địa chỉ MAC của máy ảo
            
            Source: sử dụng kiểu kết nối nào ở đây là sủ dụng linux bridge và có interface là tap2.
            
            mode type: kiểu card mạng sử dụng là virtio.
            
            link state : trạng thái.
            
            address type: kiểu địa chỉ.
            ```

    + Thẻ `input`: Chỉ có 1 tham số bắt buộc đó là type, các giá trị có thể chọn là ‘mouse’, ‘tablet’, ‘keyboard’ hoặc ‘passthrough’. Tham số bus để xác định chính xác thiết bị, các giá trị có thể chọn là “xen” (paravirtualized), “ps2”, “usb” và “virtio”

    + Thẻ `graphic`: Thuộc tính bắc buộc là type, các giá trị có thể chọn : “sdl”, “vnc”, “spice”, “rdp” và “desktop”. Đối với mỗi loại sẽ có thêm những tham số được thêm vào.







