# 1. Virsh là gì
- Libvirt là một bộ các phần mềm mà cung cấp các cách thuận tiện để quản lý máy ảo và các chức năng của ảo hóa. Những phần mềm này bao gồm một thư viện API daemon (libvirtd) và các gói tiện tích giao diện dòng lệnh (virsh)

- Virsh là một tools kiểm soát và thực hiện hành động với các máy ảo

# 2. Một số lệnh virsh
### 2.1. Khởi tạo VM
```sh
    virt-install [OPTION]...
```

```sh
    # Ví dụ về tạo VM từ file iso có sẵn
    virt-install \
        --connect qemu:///system \
        --name ubuntu-server-22-04-1 \
        --ram 512 \
        --vcpus 2 \
        --disk path=/var/lib/libvirt/images/ubuntu-2204-1.qcow2,size=10,format=qcow2 \
        --os-variant ubuntu22.04 \
        --virt-type kvm \
        --graphics none \
        --cdrom /var/lib/libvirt/images/ubuntu-22.04.5-live-server-amd64.iso \
        --network network=default,model=virtio \
        --boot cdrom,hd
        --extra-args "console=ttyS0"
```

### 2.2. Khởi động máy ảo
```sh
    virsh start [VMname]
```

### 2.3. Tắt 1 máy ảo
```sh
    virsh shutdown [VMname]
```

### 2.4. Xem thông tin 1 máy ảo
```sh
    virsh dominfo [VMname]
```

### 2.5. Chỉnh sửa thông số của máy ảo
```sh
    virsh edit [VMname]

    # Cập nhật lại thay đổi
    virsh define [VMname]
```

### 2.6. Xóa một máy ảo
```sh
    virsh destroy [VMname]

    virsh undefine [VMname]
```

```sh
    # Xóa file image của VM
    rm -rf [path_to_file_image]
```

### 2.7. Clone 1 máy ảo mới
```sh
    virt-clone \
    > --original=Vmname \
    > --name=Vmname_clone \
    > --file=/var/kvm/images/file_image.img
```

# 3. Các câu lệnh Snapshot
### 3.1. Tạo mới một snapshot
```sh
    virsh snapshot-create-as --domain [vmname] --name [snapshot_name] --decription "...."
```

### 3.2. Xem các option trong snapshot.
```sh
    virsh --help | grep snapshot
```

# 4. Thêm disk và interface
### 4.1. Thêm disk
Tạo một disk image mới với định dạng qcow2 (hoặc raw):
```sh
    sudo qemu-img create -f qcow2 /var/lib/libvirt/images/new-disk.qcow2 5G
```

Thêm disk image đó vào máy ảo
```sh
    sudo virsh attach-disk [vm-name] /var/lib/libvirt/images/new-disk.qcow2 vdb --cache none --persistent
```

### 4.2 Thêm interface
Định nghĩa interface bằng file XML (vd: new-network.xml)
```sh
    # Tạo với kiểu NAT
    <network>
        <name>custom-net</name>
        <bridge name='virbr10'/>
        <forward mode='nat'/>
        <ip address='192.168.100.1' netmask='255.255.255.0'/>
    </network>
```

```sh
    # Tạo với kiểu isolate
    <network>
        <name>custom-net</name>
        <ip address="192.168.100.1" netmask="255.255.255.0">
            <dhcp>
                <range start="192.168.100.128" end="192.168.100.254"/>
            </dhcp>
        </ip>
    </network>
```

Tạo và chạy network interface
```sh
    # Định nghĩa network interface
    virsh net-define new-network.xml

    # Chạy network interface
    virsh net-start custom-net

    # Tự động chạy
    virsh net-autostart custom-net
```

Kiểm tra các interface
```sh
    virsh net-list --all
```

Thêm interface vào máy ảo
```sh
    # Thêm interface
    sudo virsh attach-interface --domain [vm-name] --type network --source custom-net --model virtio --persistent

    # Kiểm tra các interface của máy ảo
    virsh domiflist [vm-name]
```



