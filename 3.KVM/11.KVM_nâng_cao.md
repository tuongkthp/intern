# 1. Migration
### 1.1. Migration là gì?
Migration cung cấp khả năng di chuyển các máy ảo đang chạy giữa các host vật lý. Migration được tạo ra để làm nhiệm vụ bảo trì và nâng cấp hệ thống
- Cân bằng tải: Di chuyển VMs tới các host khác khi phát hiện host đang chạy có dấu hiệu quá tải

- Bảo trì, nâng cấp hệ thống: Di chuyển các VMs ra khỏi host trước khi tắt nó đi

- Khôi phục lại máy ảo khi host gặp lỗi: Restart máy ảo trên một host khác

Migrate có 2 loại cơ chế là là offlive migrate và live migrate

### 2.1. Offlive migrate
Cơ chế Offline Migrate: là cơ chế cần phải tắt guest đi thực hiện việc di chuyển image và file xml của guest sang một host khác

### 2.2. Live migrate
Live migration cung cấp khả năng di chuyển các máy ảo đang chạy giữa các host vật lý mà không làm gián đoạn dịch vụ 

Khả năng live migration là trong suốt với người dùng, các máy ảo vẫn duy trì trạng thái bật, kết nối mạng vẫn đảm bảo và các ứng dụng của người dùng vẫn tiếp tục duy trì trong khi máy ảo được đưa sang một host vật lý mới

# 2. Snapshot
### 2.1. Cơ chế tạo snapshot
Snapshot là ghi lại tất cả trạng thái, tất cả những gì liên quan đến máy ảo ở một thời điểm nhất định

Có thể liệu gom thành một khối và khi tạo một bản sao snapshot mới thì các dữ liệu cũ được đóng lại

Chỉ có thể đọc với khối đó và sẽ có một khối mới nối tiếp với khối cũ

Và bây giờ tất cả trạng thái của VM nếu thay đổi gì thì sẽ được ghi lại trên khối mới mày. Nếu VM cần sử dụng một dữ liệu nào đó trong khối cũ thì nó sẽ đọc ở trong khối đó còn nếu thay đổi gì thì nó không được thay đổi trực tiếp trên khối cũ đó mà được ghi trên khối mới nhất

### 2.2. Convert một bản snapshot
Với mỗi một khối như thế là một bản snapshot. Khi muốn sử dụng lại bản snapshot nào đó thì VM sẽ tiến hành copy cái khối tương ứng với bản snapshot đó vào khối đang sử dụng

# 3. Backup và Restore
### 3.1. Cách phương pháp backup
Backup file hình ảnh ổ đĩa (qcow2/raw):
- Đơn giản, dễ dùng

- Chỉ cần sao chép file `.qcow2` hoặc `.raw`

Backup XML configuration
- Lưu lại cấu hình VM (CPU, RAM, network, disk mapping…)

- Không gồm dữ liệu ổ cứng

Backup “live snapshot” (VM đang chạy)

### 3.2 Restore
Copy lại disk image
```sh
    sudo cp /backup/vm-name.qcow2 /var/lib/libvirt/images/
```

Định nghĩa lại máy ảo
```sh
    sudo virsh define //backup/file.xml
```

Chạy máy ảo
```sh
    sudo virsh start [vm-name]
```

Restore sang máy khác(Migration) sẽ copy disk image và 'file.xml' của máy ảo sang máy đó rồi chạy lại như trên