# 1. Cài đặt cấu hình Neutron với openvswitch mô hình provider

## 1.1 Cài đặt trên controller
Khởi động network
```sh
systemctl restart network
```

Cài các thành phần:
```sh
apt install neutron-server neutron-plugin-ml2 \
  neutron-openvswitch-agent neutron-dhcp-agent \
  neutron-metadata-agent
```

Chỉnh sửa file cấu hình /etc/neutron/plugins/ml2/ml2_conf.ini 
```sh
[ml2]
type_drivers = flat,vlan
tenant_network_types =
mechanism_drivers = openvswitch
extension_drivers = port_security

[ml2_type_flat]
flat_networks = provider

[ml2_type_vlan]
network_vlan_ranges = provider

[securitygroup]
firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
enable_ipset = True
```

Chỉnh sửa file cấu hình openvswitch-agent /etc/neutron/plugins/ml2/openvswitch_agent.ini
```sh
[ovs]
bridge_mappings = provider:br-provider

[securitygroup]
enable_security_group = True
firewall_driver = iptables_hybrid
```

Chỉnh sửa file cấu hình DHCP agent /etc/neutron/dhcp_agent.ini.
```sh
[DEFAULT]
interface_driver = openvswitch
dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
enable_isolated_metadata = True
force_metadata = True
```

Tạo OVS provider
```sh
ovs-vsctl add-br br-provider
```

Gán interface provider vào OVS provider
```sh
ovs-vsctl add-port br-provider eth1
```

Tạo file cấu hình `/etc/sysconfig/network-scripts/ifcfg-eth1` mới
```sh
DEVICE=eth1
NAME=eth1
DEVICETYPE=ovs
TYPE=OVSPort
OVS_BRIDGE=br-provider
ONBOOT=yes
BOOTPROTO=none
NM_CONTROLLED=no
```

Tạo file cấu hình `/etc/sysconfig/network-scripts/ifcfg-br-provider` mới
```sh
ONBOOT=yes
IPADDR=10.20.1.198
NETMASK=255.255.255.0
#GATEWAY=10.10.101.1
#DNS1=8.8.8.8
DEVICE=br-provider
NAME=br-provider
DEVICETYPE=ovs
OVSBOOTPROTO=none
TYPE=OVSBridge
DEFROUTER=no
```

Lưu ý phải có thêm `DEFROUTER` vì ko có nó sẽ bị đưa đến router default dẫn đến không truy cập dc vào host.

Đồng bộ database
```sh
su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf \
  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron
```

Restart dịch vụ compute api
```sh
service nova-api restart
```

Restart dịch vụ Networking
```sh
service neutron-server restart
service neutron-openvswitch-agent restart
service neutron-dhcp-agent restart
service neutron-metadata-agent restart
```

## 1.2. Cài đặt trên compute node
Cài package ovs
```sh
apt install neutron-openvswitch-agent
```

Chỉnh sửa file cấu hình /etc/neutron/plugins/ml2/openvswitch_agent.ini:
```sh
[ovs]
bridge_mappings = provider:br-provider

[securitygroup]
enable_security_group = True
firewall_driver = iptables_hybrid
```

Tạo OVS provider
```sh
ovs-vsctl add-br br-provider
```

Tạo file cấu hình /etc/sysconfig/network-scripts/ifcfg-eth1 mới
```sh
DEVICE=eth1
NAME=eth1
DEVICETYPE=ovs
TYPE=OVSPort
OVS_BRIDGE=br-provider
ONBOOT=yes
BOOTPROTO=none
NM_CONTROLLED=no
```

Tạo file cấu hình /etc/sysconfig/network-scripts/ifcfg-br-provider mới
```sh
ONBOOT=yes
IPADDR=10.20.1.72
NETMASK=255.255.255.0
# GATEWAY=10.20.1.1
# DNS1=8.8.8.8
DEVICE=br-provider
NAME=br-provider
DEVICETYPE=ovs
OVSBOOTPROTO=none
TYPE=OVSBridge
DEFROUTER=no
```

Restart network và openvswitch-agent
```sh
systemctl restart networktha
systemctl restart neutron-openvswitch-agent.service
```

Tiến hành cấu hình tương tự với node compute còn lại.

1.3 Tạo network, subnet và instance trên provider
Tạo dải mạng sử dụng lệnh.
```sh
openstack network create --share --provider-physical-network provider --provider-network-type flat br-provider
```

Tạo subnet cho dải br-provider
```sh
openstack subnet create --subnet-range 10.20.1.0/24 --gateway 10.10.101.1 --network br-provider --allocation-pool start=10.20.1.100,end=10.20.1.250 --dns-nameserver 8.8.8.8 ovs-provider
```

Tạo instance thì thêm `--nic`
```sh
--nic <subnet_id>
```

# 2. Cài đặt cấu hình Neutron với openvswitch mô hình Self-service
Để cấu hình self-service cần cài đặt provider trước.

Hai phần trên là cấu hình cho mô hình provider, phần tiếp theo sẽ cấu hình thêm self-service tiếp tục phần trên

# 2.1. Tên controller node

Chỉnh sửa file /etc/neutron/neutron.conf:
```sh
[DEFAULT]
service_plugins = router
allow_overlapping_ips = True
```

Chỉnh sửa file /etc/neutron/plugins/ml2/ml2_conf.ini
```sh
[ml2]
type_drivers = flat,vlan,vxlan
tenant_network_types = vxlan
mechanism_drivers = openvswitch,l2population

[ml2_type_vxlan]
vni_ranges = 1:1000
```

Chỉnh sửa file /etc/neutron/plugins/ml2/openvswitch_agent.ini
```sh
[ovs]
bridge_mappings = provider:br-provider
local_ip = 10.20.1.198

[agent]
tunnel_types = vxlan
l2_population = True

[securitygroup]
firewall_driver = iptables_hybrid
```

### Cấu hình layer-3 agent
Chỉnh sửa file cấu hình /etc/neutron/l3_agent.ini
```sh
[DEFAULT]
interface_driver = openvswitch
external_network_bridge =
```

Khởi động lại network
```sh
systemctl restart network
```

Khởi động lại các dịch vụ 
```sh
systemctl restart openvswitch.service neutron-server.service neutron-openvswitch-agent.service neutron-dhcp-agent.service neutron-metadata-agent.service neutron-l3-agent
```

## 2.2 Trên compute
### Cấu hình openvswitch-agent
Thêm các dòng sau vào file /etc/neutron/plugins/ml2/openvswitch_agent.ini

```sh
[ovs]
local_ip = 10.20.1.72

[agent]
tunnel_types = vxlan
l2_population = True
```

Restart network
```sh
systemctl restart network
```

Khởi động lại các dịch vụ 
```sh
systemctl restart openvswitch.service
systemctl restart neutron-openvswitch-agent.service
```

Để kiểm tra, trên controller chạy câu lệnh sau
```sh
neutron agent-list
```

Xoá các agent cũ đi bằng lệnh
```sh
openstack network agent delete <id-agent>
```

## 2.3 Tạo network, subnet, instance và router
Tạo Network
```sh
openstack network create self-ovs
```

Tạo Subnet
```sh
openstack subnet create --subnet-range 192.10.2.0/24 \
  --network self-ovs --dns-nameserver 8.8.8.8  self-ovs-sub
```

Tạo instance thì thêm `--nic`
```sh
--nic <subnet_id>
```

Tạo router
```sh
openstack router create router-ovs
```

Add interface vào router
```sh
openstack router add subnet router-ovs self-ovs-sub

openstack router set --external-gateway br-provider router-ovs
```


