# 1. Cài đặt cấu hình Neutron với openvswitch mô hình provider

## 1.1 Cài đặt trên controller
Khởi động network
```sh
systemctl restart network
```

Cài các thành phần:
```sh
apt install neutron-server neutron-plugin-ml2 \
  neutron-openvswitch-agent neutron-dhcp-agent \
  neutron-metadata-agent
```

Chỉnh sửa file cấu hình /etc/neutron/plugins/ml2/ml2_conf.ini 
```sh
[ml2]
type_drivers = flat,vlan
tenant_network_types =
mechanism_drivers = openvswitch
extension_drivers = port_security

[ml2_type_flat]
flat_networks = provider

[ml2_type_vlan]
network_vlan_ranges = provider

[securitygroup]
firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
enable_ipset = True
```

Chỉnh sửa file cấu hình openvswitch-agent /etc/neutron/plugins/ml2/openvswitch_agent.ini
```sh
[ovs]
bridge_mappings = provider:br-provider

[securitygroup]
enable_security_group = True
firewall_driver = iptables_hybrid
```

Chỉnh sửa file cấu hình DHCP agent /etc/neutron/dhcp_agent.ini.
```sh
[DEFAULT]
interface_driver = openvswitch
dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
enable_isolated_metadata = True
force_metadata = True
```

Tạo OVS provider
```sh
ovs-vsctl add-br br-provider
```

Gán interface provider vào OVS provider
```sh
ovs-vsctl add-port br-provider eth1
```

Tạo file cấu hình `/etc/sysconfig/network-scripts/ifcfg-eth1` mới
```sh
DEVICE=eth1
NAME=eth1
DEVICETYPE=ovs
TYPE=OVSPort
OVS_BRIDGE=br-provider
ONBOOT=yes
BOOTPROTO=none
NM_CONTROLLED=no
```

Tạo file cấu hình `/etc/sysconfig/network-scripts/ifcfg-br-provider` mới
```sh
ONBOOT=yes
IPADDR=10.20.1.198
NETMASK=255.255.255.0
#GATEWAY=10.10.101.1
#DNS1=8.8.8.8
DEVICE=br-provider
NAME=br-provider
DEVICETYPE=ovs
OVSBOOTPROTO=none
TYPE=OVSBridge
DEFROUTER=no
```

Lưu ý phải có thêm `DEFROUTER` vì ko có nó sẽ bị đưa đến router default dẫn đến không truy cập dc vào host.

Đồng bộ database
```sh
su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf \
  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron
```

Restart dịch vụ compute api
```sh
service nova-api restart
```

Restart dịch vụ Networking
```sh
service neutron-server restart
service neutron-openvswitch-agent restart
service neutron-dhcp-agent restart
service neutron-metadata-agent restart
```

# 2. Cài đặt cấu hình Neutron với openvswitch mô hình Self-service


































