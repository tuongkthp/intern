# Sử dụng iperf3 để test kết nối giữa 2 instance

vm1:
- ens3: 192.168.10.156 (server)

vm2:
- ens3: 192.168.10.147 (client)

Test kết nối khi client gửi gói tin trên 1 luồng:
```sh
iperf3 -c 192.168.10.156
```

Kết quả:
```sh
# Trên server
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-10.02  sec  2.22 GBytes  1.90 Gbits/sec                  receiver

# Trên client
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  2.22 GBytes  1.91 Gbits/sec    0             sender
[  5]   0.00-10.02  sec  2.22 GBytes  1.90 Gbits/sec                  receiver
```

Test kết nối khi client gửi gói tin trên 5 luồng:
```sh
iperf3 -c 192.168.10.156 -P 5
```

Kết quả:
```sh
# Trên server
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-10.02  sec   468 MBytes   391 Mbits/sec                  receiver
[  8]   0.00-10.02  sec   467 MBytes   391 Mbits/sec                  receiver
[ 10]   0.00-10.02  sec   469 MBytes   393 Mbits/sec                  receiver
[ 12]   0.00-10.02  sec   469 MBytes   393 Mbits/sec                  receiver
[ 14]   0.00-10.02  sec   471 MBytes   394 Mbits/sec                  receiver
[SUM]   0.00-10.02  sec  2.29 GBytes  1.96 Gbits/sec                  receiver

# Trên client
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.02  sec   468 MBytes   391 Mbits/sec    1             sender
[  5]   0.00-10.02  sec   468 MBytes   391 Mbits/sec                  receiver
[  7]   0.00-10.02  sec   467 MBytes   391 Mbits/sec    1             sender
[  7]   0.00-10.02  sec   467 MBytes   391 Mbits/sec                  receiver
[  9]   0.00-10.02  sec   469 MBytes   393 Mbits/sec    1             sender
[  9]   0.00-10.02  sec   469 MBytes   393 Mbits/sec                  receiver
[ 11]   0.00-10.02  sec   469 MBytes   393 Mbits/sec    0             sender
[ 11]   0.00-10.02  sec   469 MBytes   393 Mbits/sec                  receiver
[ 13]   0.00-10.02  sec   471 MBytes   394 Mbits/sec    0             sender
[ 13]   0.00-10.02  sec   471 MBytes   394 Mbits/sec                  receiver
[SUM]   0.00-10.02  sec  2.29 GBytes  1.96 Gbits/sec    3             sender
[SUM]   0.00-10.02  sec  2.29 GBytes  1.96 Gbits/sec                  receiver
```

Cấu hình để tạo qos tại đây -> [QoS](./10.QoS.md)

Tạo một qos policy:
```sh
openstack port set --qos-policy bw-limiter 
```

Add rule giới hạn lưu lượng chiều vào tối đa là 5000 kb/s cho policy trên:
```sh
openstack network qos rule create --type bandwidth-limit --max-kbps 5000 --ingress bw-limiter
```

Thêm qos policy vào port của server
```sh
openstack port set --qos-policy bw-limiter fe5ae665-b138-43e9-bfd3-afe2d506de53
```

Test kết nối khi client gửi gói tin trên 1 luồng sau khi thêm qos:
```sh
iperf3 -c 192.168.10.156
```

Kết quả:
```sh
# Trên server
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-10.99  sec  6.24 MBytes  4.76 Mbits/sec                  receiver

# Trên client
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  7.80 MBytes  6.54 Mbits/sec    0             sender
[  5]   0.00-10.99  sec  6.24 MBytes  4.76 Mbits/sec                  receiver
```

Test kết nối khi client gửi gói tin trên 5 luồng sau khi thêm qos:
```sh
iperf3 -c 192.168.10.156 -P 5
```

Kết quả:
```sh
# Trên server
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-12.78  sec  1.93 MBytes  1.27 Mbits/sec                  receiver
[  8]   0.00-12.78  sec  1.48 MBytes   969 Kbits/sec                  receiver
[ 10]   0.00-12.78  sec  1.27 MBytes   832 Kbits/sec                  receiver
[ 12]   0.00-12.78  sec  1.29 MBytes   845 Kbits/sec                  receiver
[ 14]   0.00-12.78  sec  1.30 MBytes   855 Kbits/sec                  receiver
[SUM]   0.00-12.78  sec  7.26 MBytes  4.77 Mbits/sec                  receiver

# Trên client
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  3.26 MBytes  2.73 Mbits/sec    0             sender
[  5]   0.00-12.78  sec  1.93 MBytes  1.27 Mbits/sec                  receiver
[  7]   0.00-10.00  sec  2.60 MBytes  2.18 Mbits/sec    0             sender
[  7]   0.00-12.78  sec  1.48 MBytes   969 Kbits/sec                  receiver
[  9]   0.00-10.00  sec  2.43 MBytes  2.03 Mbits/sec    0             sender
[  9]   0.00-12.78  sec  1.27 MBytes   832 Kbits/sec                  receiver
[ 11]   0.00-10.00  sec  2.50 MBytes  2.09 Mbits/sec    0             sender
[ 11]   0.00-12.78  sec  1.29 MBytes   845 Kbits/sec                  receiver
[ 13]   0.00-10.00  sec  2.50 MBytes  2.09 Mbits/sec    0             sender
[ 13]   0.00-12.78  sec  1.30 MBytes   855 Kbits/sec                  receiver
[SUM]   0.00-10.00  sec  13.3 MBytes  11.1 Mbits/sec    0             sender
[SUM]   0.00-12.78  sec  7.26 MBytes  4.77 Mbits/sec                  receiver
```

-> Khi thêm qos policy vào tốc độ nhận tin của server đã bị giới hạn














