# Migrate Instance trong Opensatck
Openstack hỗ trợ 2 kiểu migration đó là:

- Cold migration: Non-live migration

- Live migration:
    + True live migration (shared storage or volume-based)

    + Block live migration

### 1. Cold Migrate ( Non-live migrate)
- Cold migrate khác live migrate ở chỗ nó thực hiện migration khi tắt máy ảo ( Libvirt domain không chạy)

- Yêu cầu SSH key pairs được triển khai cho user đang chạy nova-compute với mọi hypervisors

- Cold migrate workflow:
    + Tắt máy ảo ( tương tự “virsh destroy” ) và disconnect các volume.

    + Di chuyển thư mục hiện hành của máy ảo ra ngoài ( (instance_dir -> instance_dir_resize). Tiến trình resize instance sẽ tạo ra thư mục tạm thời.

    + Nếu sử dụng QCOW2, convert image sang dạng RAW.

    + Với hệ thống shared storage, di chuyển thư mục instance_dir mới vào. Nếu không, copy thông qua SCP.

### 2. Live migration
- Thực hiện bởi câu lệnh "nova live-migration [--block-migrate]"

- Có 2 loại live migration: normal migration và “block” migrations:
    + Normal live migration yêu cầu cả hai source và target hypervisor phải truy cập đến data của instance ( trên hệ thống lưu trữ có chia sẻ, ví dụ: NAS, SAN)

    + Block migration không yêu cầu đặc biệt gì đối với hệ thống storage. Instance disk được migrated như một phần của tiến trình.

- Live migrations là một trong những thao tác vận hành mang tính nhạy cảm nhất liên quan đến phiên bản của QEMU đang chạy trên máy chủ nguồn và đích.

- Live Migration Workflow:
    + Kiểm tra storage backend là thích hợp với loại migration hay không:
        * Thực hiện kiểm ta hệ thống shared storage cho normal migrations

        + Thực hiện kiểm tra các yêu cầu cho block migrations

        + Kiểm tra trên cả source và destination, điều phối thông qua RPC calls từ scheduler

    + Trên destination:
        * Tạo các kết nối volume cần thiết.

        * Nếu là block migration, tạo thư mục instance, lưu lại các file bị mất từ Glance và tạo instance disk trống.

        * Trên source, khởi tạo tiến trình migration.

        * Khi tiến trình hoàn tất, tái sinh file Libvirt XML và define nó trên destination.

Dưới đây minh họa cho quá trình live migrate VM:
![lm1](img/Lmigration-1.png)

![lm2](img/Lmigration-2.png)

![lm3](img/Lmigration-3.png)

![lm4](img/Lmigration-4.png)

![lm5](img/Lmigration-5.png)

# So sánh 2 loại migration
### Cold migrate
- Ưu điểm:
    + Đơn giản, dễ thực hiện

    + Thực hiện được với mọi loại máy ảo

- Hạn chế:
    + Thời gian downtime lớn

    + Không thể chọn được host muốn migrate tới.

    + Quá trình migrate có thể mất một khoảng thời gian dài

### Live migrate
- Ưu điểm:
    + Có thể chọn host muốn migrate

    + Tiết kiệm chi phí, tăng sự linh hoạt trong khâu quản lí và vận hành.

    + Giảm thời gian downtime và gia tăng thêm khả năng "cứu hộ" khi gặp sự cố

- Nhược điểm:
    + Dù chọn được host nhưng vẫn có những giới hạn nhất định

    + Quá trình migrate có thể fails nếu host bạn chọn không có đủ tài nguyên.

    + Bạn không được can thiệp vào bất cứ tiến trình nào trong quá trình live migrate.

    + Khó migrate với những máy ảo có dung lượng bộ nhớ lớn và trường hợp hai host khác CPU.

- Trong live-migrate có hai loại là True và Block live migration. Dưới đây là mô tả một số các loại storage hỗ trợ hai loại migration này:

![type](img/typeLM.png)




