# 1. Tổng quan

- Giống với nova-scheduler, cinder cũng có một daemon chịu trách nhiệm cho việc quyết định xem sẽ tạo cinder colume ở đâu khi mô hình có nhiều hơn một backend storage. Mặc định, nếu người dùng không chỉ rõ host để tạo thì cinder-scheduler sẽ thực hiện filter và weight như sau:

```sh
# Which filter class names to use for filtering hosts when not specified in the
# request. (list value)
#scheduler_default_filters = AvailabilityZoneFilter,CapacityFilter,CapabilitiesFilter

# Which weigher class names to use for weighing hosts. (list value)
#scheduler_default_weighers = CapacityWeigher
```

- Khi có nhiều backend thì bắt buộc phải kích hoạt filter_scheduler

# 2. Cinder Scheduler Filters
- `AvailabilityZoneFilter`: Filter bằng availability zone

- `CapabilitiesFilter`: Filter theo tài nguyên (máy ảo và volume)

- `CapacityFilter`: Filter dựa vào công suất sử dụng của volume backend

- `DifferentBackendFilter`: Lên kế hoạch đặt các volume ở các backend khác - - nhau khi có 1 danh sách các volume

- `DriverFilter`: Dựa vào ‘filter function’ và metrics.

- `InstanceLocalityFilter`: lên kế hoạch cho các volume trên cùng 1 host. Để có thể dùng filter này thì Extended Server Attributes cần được bật bởi nova và user sử dụng phải được khai báo xác thực trên cả nova và cinder.

- `JsonFilter`: Dựa vào JSON-based grammar để chọn lựa backends

# 3. Cinder Scheduler Weights
- AllocatedCapacityWeigher : Allocated Capacity Weigher sẽ tính trọng số của host bằng công suất được phân bổ. Nó sẽ đặt volume vào host được khai báo chiếm ít tài nguyên nhất.

- CapacityWeigher: Trạng thái công suất thực tế chưa được sử dụng.

- ChanceWeigher: Tính trọng số random, dùng để tạo các volume khi các host gần giống nhau (random)

- GoodnessWeigher: Gán trọng số dựa vào goodness function.
```sh
  0 -- host is a poor choice
   .
   .
  50 -- host is a good choice
   .
   .
 100 -- host is a perfect choice
 ```

- VolumeNumberWeigher: Tính toán trọng số của các host bởi số lượng volume trong backends.

# 4. Quản lý Block Storage scheduling
- Với một người dùng quản trị, có thể điều khiển volume sẽ được tạo trên backend nào.

- Có thể chỉ định `affinity` hoặc `anti-affinity` giữa 2 volume.

- `Affinity` giữa các volume có nghĩa là volume được lưu trữ trên cũng một backend

- `anti-affinity` giữa các volume có nghĩa là volume được lưu trữ trên các backend khác nhau

### Một số câu lệnh
- Tạo một volume trên cũng backend với Volume_A:
```sh
openstack volume create --hint same_host=Volume_A-UUID \
--size SIZE VOLUME_NAME
```

- Tạo một volume trên một backend khác với Volume_A:
```sh
openstack volume create --hint different_host=Volume_A-UUID \
--size SIZE VOLUME_NAME
```

- Tạo một volume trên cũng backend với Volume_A và Volume_B:
```sh
openstack volume create --hint same_host=Volume_A-UUID \
--hint same_host=Volume_B-UUID --size SIZE VOLUME_NAME
```

- Tạo một volume trên một backend khác với cả Volume_A và Volume_B:
```sh
openstack volume create --hint different_host=Volume_A-UUID \
--hint different_host=Volume_B-UUID --size SIZE VOLUME_NAME
```

















